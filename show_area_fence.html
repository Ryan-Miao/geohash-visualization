<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>geohash</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="./jquery.min.js"></script>
    <script src="./latlon-geohash.js"></script>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=rTftA1rhmp7dbId0B2j3qTd2"></script>

    <style type="text/css">
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "微软雅黑";
        }

        #allmap {
            height: 70%;
            width: 100%;
        }

        #control {
            width: 100%;
        }
    </style>
</head>

<body>

    输入高德围栏：
    <input type="text" name="" id="fence" size="200" value="118.876388,31.324514;118.876602,31.323662;118.875626,31.323419;118.875331,31.324205;118.875943,31.324441;118.876388,31.324514">

    <input type="button" value="显示围栏" id="search">

    <a href="./show_all.html">标记geohash</a>
    <a href="./show_all.html">显示geohash 9宫格</a>
    <a href="./show_all.html">显示电子围栏</a>


    <div id="allmap"></div>


    <script type="text/javascript">

        var map = new BMap.Map("allmap");


        var bp_arr = new Array();
        // 根据点的数组自动调整缩放级别
        function set_zoom(bp_arr) {
            var view = map.getViewport(eval(bp_arr));
            var mapZoom = view.zoom;
            var centerPoint = view.center;
            map.centerAndZoom(centerPoint, mapZoom);
        }




        /**
         * 添加多边形
         * */
        function add_ploygon(p_arr) {
            var point_arr = p_arr.map(function (item, index) {
                var bp = new BMap.Point(item.longitude, item.latitude);
                bp_arr.push(bp);
                // var marker = new BMap.Marker(bp);  // 创建标注
                // map.addOverlay(marker);              // 将标注添加到地图中
                // var label = new BMap.Label(item.geohash,{offset:new BMap.Size(20,-10)});
                // marker.setLabel(label);
                return bp;
            });
            var polygon = new BMap.Polygon(point_arr, { strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5 });  //创建多边形
            map.addOverlay(polygon);   //增加多边形  
            set_zoom(bp_arr);
        }

        /**
         * 获取经纬度数组
         * */
        function get_fence() {
            var fence = $("#fence").val();
            var gps_arr = fence.split(";");
            return gps_arr.map(gps_str => {
                var gps = gps_str.split(",");
                var lon_lat = {
                    longitude: gps[0],
                    latitude: gps[1]
                };
                return gaode2baidu( gps[0],  gps[1]);
               
            });
        }

        //百度坐标转高德（传入经度、纬度）
        function baidu2gaode(bd_lng, bd_lat) {
            var X_PI = Math.PI * 3000.0 / 180.0;
            var x = bd_lng - 0.0065;
            var y = bd_lat - 0.006;
            var z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * X_PI);
            var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * X_PI);
            var gg_lng = z * Math.cos(theta);
            var gg_lat = z * Math.sin(theta);
            return {longitude: gg_lng, latitude: gg_lat}
        }
        //高德坐标转百度（传入经度、纬度）
        function gaode2baidu(gg_lng, gg_lat) {
            var X_PI = Math.PI * 3000.0 / 180.0;
            var x = gg_lng, y = gg_lat;
            var z = Math.sqrt(x * x + y * y) + 0.00002 * Math.sin(y * X_PI);
            var theta = Math.atan2(y, x) + 0.000003 * Math.cos(x * X_PI);
            var bd_lng = z * Math.cos(theta) + 0.0065;
            var bd_lat = z * Math.sin(theta) + 0.006;
            return {
                latitude: bd_lat,
                longitude: bd_lng
            };
        }

    </script>


    <script>

        $(function () {
            $("#search").click(init);

        });

        function init() {
            // 百度地图API功能
            map = new BMap.Map("allmap");
            map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);
            map.enableScrollWheelZoom();

            //单击获取点击的经纬度
            map.addEventListener("click", function (e) {
                console.log("拾取经纬度：", e.point)
                console.log(e.point.lng + "," + e.point.lat);
                var gaode_gps = baidu2gaode(e.point.lng, e.point.lat);
                console.log("gaode:", gaode_gps.longitude +","+gaode_gps.latitude);
                
            });

            bp_arr = new Array();
            var fence = get_fence();
            console.log("获取到fence: ", fence);
            add_ploygon(fence);
        }


        init();

    </script>

</body>

</html>